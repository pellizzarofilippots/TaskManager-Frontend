


<!-- HEADER CON MEMBRI -->
<div class="project-header">
  <div class="header-top">
    <h2>Gestione Progetto</h2>
    <button class="btn-add-member" (click)="showAssegnazioneForm = !showAssegnazioneForm" *ngIf="isAdmin()">
      + Aggiungi membro
    </button>
  </div>
  
  <!-- Mini cards membri (solo se ci sono assegnazioni) -->
  <div class="team-preview" *ngIf="assegnazioni.length > 0">
    <div class="team-member-mini" *ngFor="let a of assegnazioni">
      <div class="member-avatar">{{ getPersonaInitials(a.personaId) }}</div>
      <div class="member-info">
        <span class="member-name">{{ getPersonaNome(a.personaId) }}</span>
        <span class="member-role">{{ getRuoloProgettoNome(a.ruoloProgettoId) }}</span>
      </div>
    </div>
  </div>

  <!-- Messaggio se nessun membro -->
  <div class="no-members" *ngIf="assegnazioni.length === 0">
    <p>Nessun membro assegnato al progetto</p>
  </div>
</div>

<!-- FORM ASSEGNAZIONE MEMBRO (MODALE/COLLAPSABILE) -->
<div class="form-modal" *ngIf="showAssegnazioneForm">
  <div class="form-container">
    <div class="form-header">
      <h3>Aggiungi membro al team</h3>
      <button class="btn-close" (click)="showAssegnazioneForm = false">×</button>
    </div>

    <div class="form-body">
      <div class="form-row">
        <div class="form-group">
          <label>Persona *</label>
          <select [(ngModel)]="tempAssegnazione.personaId" class="form-control">
            <option [ngValue]="0">Seleziona persona</option>
            <option *ngFor="let anagrafica of anagrafiche" [ngValue]="anagrafica.id">
              {{ anagrafica.nome }} {{ anagrafica.cognome }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Ruolo *</label>
          <select [(ngModel)]="tempAssegnazione.ruoloProgettoId" class="form-control">
            <option [ngValue]="0">Seleziona ruolo</option>
            <option *ngFor="let ruolo of ruoliProgetto" [ngValue]="ruolo.id">
              {{ ruolo.etichetta }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Permessi</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="tempAssegnazione.hasPrgGestisci">
            <span>Gestisci progetto</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="tempAssegnazione.hasAttAggiungi">
            <span>Aggiungi attività</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="tempAssegnazione.hasAttAssegna">
            <span>Assegna attività</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="tempAssegnazione.hasAttStato">
            <span>Modifica stato</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="tempAssegnazione.hasAttPrendi">
            <span>Prendi in carico</span>
          </label>
        </div>
      </div>
    </div>

    <div class="form-footer">
      <button class="btn-secondary" (click)="showAssegnazioneForm = false">Annulla</button>
      <button class="btn-primary" (click)="addAssegnazione()">Aggiungi membro</button>
    </div>
  </div>
</div>

<!-- SEZIONE ATTIVITÀ (CENTRO PAGINA) -->
<div class="activities-section">
  
  <!-- Toolbar con bottone nuova attività -->
  <div class="activities-toolbar">
    <h3>Attività del progetto</h3>
    <button class="btn-primary" (click)="nuovaAttivita()">
      + Nuova Attività
    </button>
  </div>

  <!-- FORM CREAZIONE ATTIVITÀ (COLLAPSABILE) -->
  <div class="form-inline-card" *ngIf="showAttivitaForm">
    <div class="form-header">
      <!--h4>Crea nuova attività</h4-->
      <h4>{{ isEditMode ? 'Modifica attività' : 'Crea nuova attività' }}</h4>
      <button class="btn-close" (click)="showAttivitaForm = false">×</button>
    </div>

    <div class="form-grid">
      <div class="form-group span-2">
        <label>Nome attività *</label>
        <input type="text" [(ngModel)]="tempAttivita.nome" placeholder="Es: Implementare login" class="form-control">
      </div>

      <div class="form-group">
        <label>Tipo *</label>
        <select [(ngModel)]="tempAttivita.tipoId" class="form-control">
          <option [ngValue]="0">Seleziona tipo</option>
          <option *ngFor="let tipo of tipiAttivita" [ngValue]="tipo.id">
            {{ tipo.etichetta }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Stato *</label>
        <select [(ngModel)]="tempAttivita.statoId" class="form-control">
          <option [ngValue]="0">Seleziona stato</option>
          <option *ngFor="let stato of stati" [ngValue]="stato.id">
            {{ stato.etichetta }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Priorità *</label>
        <select [(ngModel)]="tempAttivita.prioritaId" class="form-control">
          <option [ngValue]="0">Seleziona priorità</option>
          <option *ngFor="let p of priorita" [ngValue]="p.id">
            {{ p.etichetta }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Assegnato a</label>
        <select [(ngModel)]="tempAttivita.operatoreId" class="form-control">
          <option [ngValue]="0">Non assegnato</option>
          <option *ngFor="let anagrafica of anagrafiche" [ngValue]="anagrafica.id">
            {{ anagrafica.nome }} {{ anagrafica.cognome }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Data inizio *</label>
        <input type="date" [(ngModel)]="tempAttivita.inizio" class="form-control">
      </div>

      <div class="form-group">
        <label>Data fine</label>
        <input type="date" [(ngModel)]="tempAttivita.fine" class="form-control">
      </div>

      <div class="form-group span-3">
        <label>Descrizione</label>
        <textarea [(ngModel)]="tempAttivita.descrizione" placeholder="Descrivi l'attività..." rows="3" class="form-control"></textarea>
      </div>
    </div>

    <div class="form-footer">
      <button class="btn-secondary" (click)="showAttivitaForm = false">Annulla</button>
      <!--button class="btn-success" (click)="addAttivita()">Crea attività</button-->
      <button class="btn-success" (click)="addAttivita()">
  {{ isEditMode ? 'Salva modifiche' : 'Crea attività' }}
</button>
    </div>
  </div>

  <!-- Lista attività con cards -->
  <div class="activities-list">
    
    <!-- Se non ci sono attività -->
    <div *ngIf="attivita.length === 0" class="empty-message">
      <p>Nessuna attività creata. Inizia creando la prima attività!</p>
    </div>

    <!-- Card per ogni attività -->
    <div class="activity-card" *ngFor="let att of attivita">
      
      <!-- Header card -->
      <div class="card-header">
        <div class="card-title">
          <span class="activity-id">#{{ att.id }}</span>
          <h4>{{ att.nome }}</h4>
        </div>
        <!--div class="card-actions">
          <button class="btn-edit" (click)="modificaAttivita(att)">Modifica</button>
          <button class="btn-delete">Elimina</button>
        </div-->

        <div class="card-actions">
         <button class="btn-edit" (click)="modificaAttivita(att)">Modifica</button>
        <button class="btn-delete" (click)="eliminaAttivita(att.id)">Elimina</button>
        <button class="btn-registra" (click)="toggleRegistraLavoro(att)">+ Registra</button>
        </div>
      </div>

      <!-- Descrizione (se presente) -->
      <p class="card-description" *ngIf="att.descrizione">
        {{ att.descrizione }}
      </p>

      <!-- Info row (stato, priorità, assegnato, date) -->
      <div class="card-info">
        <span class="info-badge badge-status">
          {{ getStatoNome(att.statoId) }}
        </span>
        <span class="info-badge badge-priority">
          {{ getPrioritaNome(att.prioritaId) }}
        </span>
        <span class="info-badge badge-assignee" *ngIf="att.operatoreId">
          {{ getPersonaNome(att.operatoreId) }}
        </span>
        <span class="info-date">
          {{ att.inizio | date: 'dd/MM/yyyy' }} - {{ att.fine | date: 'dd/MM/yyyy' }}
        </span>
      </div>

      <!-- AGGIUNGI QUESTO CODICE DENTRO OGNI activity-card, DOPO il div card-info -->

      <!-- Bottoni azioni (MODIFICA QUESTA SEZIONE) -->
      <div class="card-actions">
        <button class="btn-edit" (click)="modificaAttivita(att)">Modifica</button>
        <button class="btn-delete" (click)="eliminaAttivita(att.id)">Elimina</button>
        <button class="btn-registra" (click)="toggleRegistraLavoro(att)">+ Registra</button>
      </div>

      <!-- FORM REGISTRAZIONE LAVORO (NUOVO) -->
      <div class="registra-lavoro-form" *ngIf="attivitaRegistraLavoro?.id === att.id">
        <h5>Registra lavoro svolto</h5>
        
        <div class="form-row-compact">
          <div class="form-group-compact">
            <label>Data *</label>
            <input type="date" [(ngModel)]="tempEsecuzione.data" class="form-control-compact">
          </div>
          
          <div class="form-group-compact">
            <label>Ore lavorate *</label>
            <input type="number" step="0.5" min="0" max="24" 
                   [(ngModel)]="tempEsecuzione.durata" 
                   placeholder="Es: 2.5"
                   class="form-control-compact">
          </div>
          
          <div class="form-group-compact">
            <label>Operatore *</label>
            <select [(ngModel)]="tempEsecuzione.operatoreId" class="form-control-compact">
              <option [ngValue]="0">Seleziona</option>
              <option *ngFor="let anagrafica of anagrafiche" [ngValue]="anagrafica.id">
                {{ anagrafica.nome }} {{ anagrafica.cognome }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group-compact">
          <label>Note</label>
          <textarea [(ngModel)]="tempEsecuzione.note" 
                    rows="2" 
                    placeholder="Descrivi il lavoro svolto..."
                    class="form-control-compact"></textarea>
        </div>

        <div class="form-actions-compact">
          <button class="btn-success-small" (click)="salvaEsecuzione(att.id!)">Salva</button>
          <button class="btn-secondary-small" (click)="annullaRegistraLavoro()">Annulla</button>
        </div>
      </div>

      <!-- TOGGLE ESECUZIONI (NUOVO) -->
      <div class="esecuzioni-toggle" *ngIf="getEsecuzioniCount(att.id!) > 0">
        <button class="toggle-button" (click)="toggleEsecuzioni(att.id!)">
          <span class="toggle-icon">{{ isEsecuzioniExpanded(att.id!) ? '▼' : '▶' }}</span>
          Lavoro registrato ({{ getEsecuzioniCount(att.id!) }} sessioni)
        </button>
      </div>

      <!-- LISTA ESECUZIONI (NUOVO) -->
      <div class="esecuzioni-list" *ngIf="isEsecuzioniExpanded(att.id!)">
        <div class="esecuzione-item" *ngFor="let exec of getEsecuzioni(att.id!)">
          <div class="esecuzione-info">
            <span class="esecuzione-data">{{ exec.data | date: 'dd/MM/yyyy' }}</span>
            <span class="esecuzione-durata">{{ exec.durata }}h</span>
            <span class="esecuzione-operatore">{{ getPersonaNome(exec.operatoreId) }}</span>
          </div>
          <div class="esecuzione-note" *ngIf="exec.note">
            {{ exec.note }}
          </div>
          <button class="btn-delete-small" (click)="eliminaEsecuzione(exec.id!, att.id!)">
            Elimina
          </button>
        </div>
        
        <div class="esecuzioni-totale">
          <strong>Totale ore:</strong> {{ calcolaTotaleOre(att.id!) }}h
        </div>
      </div>

    </div> <!-- Fine activity-card -->

    </div>


